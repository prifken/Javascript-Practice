<!-- This script replaced workato in the process of summarizing opportunity details and spitting to QB App; this version does not leverage OOP--> 
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.2/jquery.min.js"></script>
<script>

  var url = "https://team.quickbase.com";     // Remember to put in YOUR baseURL
  url    += "/db/";
  url    += "bk9nusrfc";                                   // Remember to put in YOUR tableDBID
  url    += "?a=API_DoQuery";

  var request = "<qdbapi>";
  request    += "<usertoken>b287yg_uyp_dsagzw8b755gx7bvr8hfmdp3fu53</usertoken>";            // Remember to put in YOUR appToken
  request    += "</qdbapi>";

	var count0 = 0; 
	var count1 = 0; 
	var count2 = 0;
	var count3 = 0;

	var sum_count0 = 0; 
	var sum_count1 = 0; 
	var sum_count2 = 0;
	var sum_count3 = 0;

	var poc_count0 = 0; 
	var poc_count1 = 0; 
	var poc_count2 = 0;
	var poc_count3 = 0;

	var poc_sum_count0 = 0; 
	var poc_sum_count1 = 0; 
	var poc_sum_count2 = 0;
	var poc_sum_count3 = 0;

	var oc_count0 = 0; 
	var oc_count1 = 0; 
	var oc_count2 = 0;
	var oc_count3 = 0;

	var oc_sum_count0 = 0; 
	var oc_sum_count1 = 0; 
	var oc_sum_count2 = 0;
	var oc_sum_count3 = 0;

$.ajax({
type: "POST",
contentType: "text/xml",
async: false,
url: url,
dataType: "xml",
processData: false,
data: request,
			    success: function (response) {

			     var xml = $(response); //Convert response to XML Code
			     if (xml.find('qdbapi').find('errcode').text() == "0") {
				
					var cast = 0; 
			//Looping Through Response Begins Below
									  	 xml.find('qdbapi').find('record').each(function(index){	
										    console.log("Opportunity Name = " + $(this).find("opportunity_name").text());
									    	console.log("Opportunity ID = " + $(this).find("opportunity_id").text());
									    	console.log("Coach Name = " + $(this).find("coach_name").text());
									    	console.log("Forecasted Monthly Fees = " + $(this).find("forecasted_monthly_fees").text());
									    	console.log("Opportunity Stage = " + $(this).find("current_opportunity_stage").text());
									    	//Check for Blanks
											if($(this).find("forecasted_monthly_fees").text()=="")
												{
												cast=0;
												console.log("Found Blank");
												}
											else 
												{
												cast=parseInt($(this).find("forecasted_monthly_fees").text());
												}
											//Sum if Coach Found
											if($(this).find("coach_name").text()=="Nathan T. Hise" && $(this).find("current_opportunity_stage").text()=="02 - Investigation")
												{
													count0+= cast; 
													sum_count0++;
												}
											if($(this).find("coach_name").text()=="Sean Walsh" && $(this).find("current_opportunity_stage").text()=="02 - Investigation")
												{
													count1+= cast; 
													sum_count1++;
												}
											if($(this).find("coach_name").text()=="Paul Grim" && $(this).find("current_opportunity_stage").text()=="02 - Investigation")
												{
													count2+= cast; 
													sum_count2++;
												}
											if($(this).find("coach_name").text()=="Tom Kerwin" && $(this).find("current_opportunity_stage").text()=="02 - Investigation")
												{
													count3+= cast; 
													sum_count3++;
												}
											if($(this).find("coach_name").text()=="Nathan T. Hise" && $(this).find("current_opportunity_stage").text()=="03 - Proof of Concept")
												{
													poc_count0+= cast; 
													poc_sum_count0++;
												}
											if($(this).find("coach_name").text()=="Sean Walsh" && $(this).find("current_opportunity_stage").text()=="03 - Proof of Concept")
												{
													poc_count1+= cast; 
													poc_sum_count1++;
												}
											if($(this).find("coach_name").text()=="Paul Grim" && $(this).find("current_opportunity_stage").text()=="03 - Proof of Concept")
												{
													poc_count2+= cast; 
													poc_sum_count2++;
												}
											if($(this).find("coach_name").text()=="Tom Kerwin" && $(this).find("current_opportunity_stage").text()=="03 - Proof of Concept")
												{
													poc_count3+= cast; 
													poc_sum_count3++;
												}
											if($(this).find("coach_name").text()=="Nathan T. Hise" && $(this).find("current_opportunity_stage").text()=="04 - Obtain Commitment")
												{
													oc_count0+= cast; 
													oc_sum_count0++;
												}
											if($(this).find("coach_name").text()=="Sean Walsh" && $(this).find("current_opportunity_stage").text()=="04 - Obtain Commitment")
												{
													oc_count1+= cast; 
													oc_sum_count1++;
												}
											if($(this).find("coach_name").text()=="Paul Grim" && $(this).find("current_opportunity_stage").text()=="04 - Obtain Commitment")
												{
													oc_count2+= cast; 
													oc_sum_count2++;
												}
											if($(this).find("coach_name").text()=="Tom Kerwin" && $(this).find("current_opportunity_stage").text()=="04 - Obtain Commitment")
												{
													oc_count3+= cast; 
													oc_sum_count3++;
												}
											console.log("\n\n");
									 	});//End XML Loop
				console.log("String Count ="+String(count0));
				console.log("\n\n");
			 	}
			    else 
			    {
			     console.log("Quickbase returned an error.");
			     console.log(response);
			   } 
			 },
error: function (response)
	{
	console.log("Quickbase returned an error.");
	console.log(response);
	}
});

var url3 = "https://team.quickbase.com";     // Remember to put in YOUR baseurl3
  url3    += "/db/";
  url3    += "bk9j6sa8r";                                   // Remember to put in YOUR tableDBID
  url3    += "?a=API_DoQuery";

  var request = "<qdbapi>";
  request    += "<usertoken>b287yg_uyp_dsagzw8b755gx7bvr8hfmdp3fu53</usertoken>";            // Remember to put in YOUR appToken
  request    += "</qdbapi>";

$.ajax({
type: "POST",
contentType: "text/xml",
async: false,
url: url3,
dataType: "xml",
processData: false,
data: request,
			    success: function (response) {

			     var xml = $(response); //Convert response to XML Code
			     if (xml.find('qdbapi').find('errcode').text() == "0") {
				
					var cast = 0; 
			//Looping Through Response Begins Below
									  	 xml.find('qdbapi').find('record').each(function(index){
										console.log("Coach Name = " + $(this).find("first_name").text());
													var url2 = "https://team.quickbase.com/db/bk89mdf7j?a=API_AddRecord&usertoken=b287yg_uyp_dsagzw8b755gx7bvr8hfmdp3fu53";   
													url2    += "&_fid_11="+$(this).find("first_name").text()+" "+$(this).find("last_name").text(); 
													url2    += "&_fid_14="+selectCoach($(this).find("first_name").text()); 
													url2    += "&_fid_15="+selectCoach2($(this).find("first_name").text()); 
													url2    += "&_fid_26="+selectCoach3($(this).find("first_name").text()); 
													url2    += "&_fid_27="+selectCoach4($(this).find("first_name").text()); 
													url2    += "&_fid_23="+selectCoach5($(this).find("first_name").text()); 
													url2    += "&_fid_25="+selectCoach6($(this).find("first_name").text()); 

																		
													        var rid;
													        $.ajax({
													            type: "GET",
													            contentType: "text/xml",
													            async: false,
													            url: url2,
													            dataType: "xml",
													            processData: false,
													            success: function (response) {
													        		//alert("Boom.... success baby");
													                var xml = $(response);
													                if (xml.find('qdbapi').find('errcode').text() === "0") {
													                    rid = xml.find('qdbapi').find('rid').text();
													                    console.log(rid);
													                }
													                else {
													                    console.log("Quickbase returned an error.");
													                    console.log(response);
													                } 
													            },
													            error: function (e) {
													                 console.log(e);  
													            }
													        });											
									 	});//End XML Loop
				console.log("Success");
			 	}
			    else 
			    {
			     console.log("Quickbase returned an error.");
			     console.log(response);
			   } 
			 },
error: function (response)
	{
	console.log("Quickbase returned an error.");
	console.log(response);
	}
});



function selectCoach(val){
	var answer = count0; 

	switch(val){
		case "Sean":
		answer=count1;
		console.log(val);
		break;
		case "Nathan T.":
		answer=count0;
		console.log(val);
		break;
		case "Paul":
		answer=count2;
		console.log(val);
		break;
		case "Tom":
		answer= count3;
		console.log(val);
		break;

	}
	console.log("value is "+val);
	return answer;
}

function selectCoach2(val){
	var answer = count0; 

	switch(val){
		case "Sean":
		answer=sum_count1;
		console.log(val);
		break;
		case "Nathan T.":
		answer=sum_count0;
		console.log(val);
		break;
		case "Paul":
		answer=sum_count2;
		console.log(val);
		break;
		case "Tom":
		answer= sum_count3;
		console.log(val);
		break;

	}
	console.log("value is "+val);
	return answer;
}

function selectCoach3(val){
	var answer = count0; 

	switch(val){
		case "Sean":
		answer=poc_sum_count1;
		console.log(val);
		break;
		case "Nathan T.":
		answer=poc_sum_count0;
		console.log(val);
		break;
		case "Paul":
		answer=poc_sum_count2;
		console.log(val);
		break;
		case "Tom":
		answer= poc_sum_count3;
		console.log(val);
		break;

	}
	console.log("value is "+val);
	return answer;
}

function selectCoach4(val){
	var answer = count0; 

	switch(val){
		case "Sean":
		answer=poc_count1;
		console.log(val);
		break;
		case "Nathan T.":
		answer=poc_count0;
		console.log(val);
		break;
		case "Paul":
		answer=poc_count2;
		console.log(val);
		break;
		case "Tom":
		answer= poc_count3;
		console.log(val);
		break;

	}
	console.log("value is "+val);
	return answer;
}
function selectCoach5(val){
	var answer = count0; 

	switch(val){
		case "Sean":
		answer=oc_sum_count1;
		console.log(val);
		break;
		case "Nathan T.":
		answer=oc_sum_count0;
		console.log(val);
		break;
		case "Paul":
		answer=oc_sum_count2;
		console.log(val);
		break;
		case "Tom":
		answer= oc_sum_count3;
		console.log(val);
		break;

	}
	console.log("value is "+val);
	return answer;
}

function selectCoach6(val){
	var answer = count0; 

	switch(val){
		case "Sean":
		answer=oc_count1;
		console.log(val);
		break;
		case "Nathan T.":
		answer=oc_count0;
		console.log(val);
		break;
		case "Paul":
		answer=oc_count2;
		console.log(val);
		break;
		case "Tom":
		answer= oc_count3;
		console.log(val);
		break;

	}
	console.log("value is "+val);
	return answer;
}

</script>


